type: paradedb
mode: standalone
cluster:
  instances: 1
  postgresql:
    parameters:
      wal_level: "logical"
      max_worker_processes: "20"
      max_parallel_workers: "15"
      max_wal_senders: "10"
      max_replication_slots: "10"
    pg_hba:
      - host   publisher  postgres  all     md5
  storage:
    size: 256Mi
    storageClass: standard
  monitoring:
    enabled: true
    disableDefaultQueries: true
    instrumentation:
      paradedbIndex: true
      logicalReplication: true
    customQueries:
      - name: "pg_cache_hit_ratio"
        query: "SELECT current_database() as datname, sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) as ratio FROM pg_statio_user_tables;"
        target_databases: ["*"]
        predicate_query: "SELECT '{{ .Values.type }}';"
        metrics:
          - datname:
              usage: "LABEL"
              description: "Name of the database"
          - ratio:
              usage: GAUGE
              description: "Cache hit ratio"
    podMonitor:
      relabelings:
        - targetLabel: environment
          replacement: test
        - targetLabel: team
          replacement: alpha
      metricRelabelings:
        - action: replace
          sourceLabels:
            - cluster
          targetLabel: cnpg_cluster
        - action: labeldrop
          regex: cluster
  additionalLabels:
    foo: bar
  annotations:
    foo: bar
backups:
  enabled: false
poolers:
  - name: rw
    type: rw
    instances: 1
    monitoring:
      enabled: true
      podMonitor:
        enabled: true
        relabelings:
          - targetLabel: type
            replacement: rw
          - targetLabel: team
            replacement: alpha
        metricRelabelings:
          - action: replace
            sourceLabels:
              - cluster
            targetLabel: cnpg_cluster
          - action: labeldrop
            regex: cluster
  - name: ro
    type: ro
    instances: 1
    monitoring:
      enabled: true
      podMonitor:
        enabled: true
        relabelings:
          - targetLabel: type
            replacement: ro
          - targetLabel: team
            replacement: alpha
        metricRelabelings:
          - action: replace
            sourceLabels:
              - cluster
            targetLabel: cnpg_cluster
          - action: labeldrop
            regex: cluster
monitoring:
  grafanaDashboard:
    create: true
    configMapName: "paradedb-grafana-dashboard"
    labels:
      grafana_dashboard: "1"
