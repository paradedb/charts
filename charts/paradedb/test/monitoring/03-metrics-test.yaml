---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pod-reader
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-reader
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get","list","watch"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: pod-reader-binding
subjects:
  - kind: ServiceAccount
    name: pod-reader
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: metrics-test
spec:
  template:
    spec:
      serviceAccountName: pod-reader
      restartPolicy: OnFailure
      containers:
      - name: metrics-test
        image: alpine:3.19
        command: ['sh', '-c']
        env:
          - name: NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
        args:
          - |
            apk --no-cache add curl kubectl
            set -e
            POD_IP=$(kubectl -n $NAMESPACE get pods -l cnpg.io/podRole=instance -o jsonpath="{.items[0].status.podIP}")
            echo "POD_IP: $POD_IP"
            echo "pg_stat_subscription_latest_end_lsn"
            curl "http://$POD_IP:9187/metrics" | grep pg_stat_subscription_latest_end_lsn
            echo "paradedb_index_relation_size"
            curl "http://$POD_IP:9187/metrics" | grep paradedb_index_relation_size
            echo "paradedb_index_layer_segments"
            curl "http://$POD_IP:9187/metrics" | grep paradedb_index_layer_segments
