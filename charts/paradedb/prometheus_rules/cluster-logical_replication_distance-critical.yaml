{{- $alert := "CNPGClusterLogicalReplicationDistanceCritical" -}}
{{- if not (has $alert .excludeRules) -}}
alert: {{ $alert }}
annotations:
  summary: ParadeDB CNPG Cluster Very High Logical Replication LSN distance
  description: |-
    ParadeDB CloudNativePG Cluster's "{{ .namespace }}/{{ .cluster }}" "{{ .subname }}" subscription is experiencing a very high logical replication LSN distance of {{ .value }}GB!

    High logical replication lag indicates network issues, busy instances, slow queries or suboptimal configuration.
  runbook_url: https://github.com/paradedb/charts/blob/main/charts/paradedb/docs/runbooks/{{ $alert }}.md
expr: |
  label_replace(max by (namespace, job, subname) (cnpg_pg_stat_subscription_received_lsn - cnpg_pg_stat_subscription_latest_end_lsn), "cluster", "$1", "job", ".+/(.+)") / 1024^3 > 10
for: 5m
labels:
  severity: critical
  namespace: {{ .namespace }}
  cnpg_cluster: {{ .cluster }}
{{- end -}}
